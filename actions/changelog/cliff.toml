# ref: <https://git-cliff.org/docs/configuration/>

[bump]
features_always_bump_minor = false
breaking_always_bump_major = false
initial_tag = "0.1.0"

[changelog]
# ref: <https://git-cliff.org/docs/templating/examples/>
# ref: <https://github.com/orhun/git-cliff/blob/main/cliff.toml>
# ref: <https://release-plz.dev/docs/changelog/examples>
header = """
<!-- This file is @generated by <https://github.com/liblaf/actions-src/blob/main/actions/changelog/cliff.toml>. -->
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Conventional Changelog](https://github.com/conventional-changelog/conventional-changelog-config-spec/blob/master/versions/2.2.0/README.md),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
"""
body = """
{%- macro remote_url() -%}
  https://github.com/{{ remote.github.owner }}/{{ remote.github.repo }}
{%- endmacro -%}

{%- macro pull(p) -%}
  [#{{ p }}]({{ self::remote_url() }}/pull/{{ p }})
{%- endmacro -%}

{%- macro user(u) -%}
  {%- if u is ending_with("[bot]") -%}
    {%- set botname = u | trim_end_matches(pat="[bot]") -%}
    [@{{ u }}](https://github.com/apps/{{ botname }})
  {%- else -%}
    [@{{ u }}](https://github.com/{{ u }})
  {%- endif -%}
{%- endmacro user -%}

{%- macro print_commit(c) -%}
  - {% if c.scope %}**({{ c.scope }})** {% endif -%}\
      {{ c.message }} - \
      [{{ c.id | truncate(length=7, end="") }}]({{ self::remote_url() }}/commit/{{ c.id }})\
      {%- if c.remote.username %} by {{ self::user(u=c.remote.username) }}{% endif -%}\
      {%- if c.remote.pr_number %} in {{ self::pull(p=c.remote.pr_number) }}{% endif -%}
{%- endmacro -%}

{%- macro print_breaking(c) -%}
  - {% if c.scope %}**({{ c.scope }})** {% endif -%}\
      {%- if c.breaking_description -%}
        {{ c.breaking_description }}
      {%- else -%}
        {{ c.message }}
      {%- endif %} - \
      [{{ c.id | truncate(length=7, end="") }}]({{ self::remote_url() }}/commit/{{ c.id }})\
      {%- if c.remote.username %} by {{ self::user(u=c.remote.username) }}{% endif -%}\
      {%- if c.remote.pr_number %} in {{ self::pull(p=c.remote.pr_number) }}{% endif -%}
{%- endmacro -%}

{%- if version -%}
  ## [{{ version | trim_start_matches(pat="v") }}]({{ self::remote_url() }}/releases/tag/{{ version }}) - {{ timestamp | date(format="%Y-%m-%d") }}
{% else -%}
    ## [Unreleased]
{% endif -%}

{%- if commits | filter(attribute="breaking", value=true) | length > 0 -%}
  ### ğŸ’¥ BREAKING CHANGES
  {% for commit in commits | filter(attribute="breaking", value=true) -%}
    {{ self::print_breaking(c=commit) }}
  {% endfor -%}
{%- endif -%}

{%- for group, commits in commits | group_by(attribute="group") -%}
  ### {{ group | striptags | trim | upper_first }}
  {% for commit in commits | filter(attribute="scope") | sort(attribute="scope") -%}
    {{ self::print_commit(c=commit) }}
  {% endfor -%}
  {%- for commit in commits -%}
    {%- if not commit.scope -%}
      {{ self::print_commit(c=commit) }}
    {% endif -%}
  {%- endfor -%}
{%- endfor -%}

{%- if github -%}
  {%- if github.contributors | length > 0 -%}
    ### â¤ï¸ Contributors
    {% for contributor in github.contributors -%}
      {%- if contributor.is_first_time -%}
      - {{ self::user(u=contributor.username) }} made their first contribution
        {%- if contributor.pr_number %} in {{ self::pull(p=contributor.pr_number) }}{% endif %}
      {% else -%}
      - {{ self::user(u=contributor.username) }}
      {% endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- endif -%}
"""
footer = ""
trim = true
render_always = true

[git]
conventional_commits = true
filter_unconventional = true
split_commits = false
commit_preprocessors = [
  # ref: <https://git-cliff.org/docs/tips-and-tricks#remove-gitmoji>
  # Remove gitmoji, both actual UTF emoji and :emoji:
  { pattern = '^ *(:\w+:|[\p{Emoji_Presentation}\p{Extended_Pictographic}](?:\u{FE0F})?\u{200D}?) *', replace = "" },
]
commit_parsers = [
  # ref: <https://github.com/liblaf/copier-release/blob/main/template/.config/release-please/config.json.jinja>
  # { message = '^(?<type>\w+)(\((?<scope>\w+)\))?(?<breaking>!):', group = "<!-- 00 -->ğŸ’¥ BREAKING CHANGES" },
  # { message = "BREAKING CHANGE", group = "<!-- 00 -->ğŸ’¥ BREAKING CHANGES" },
  { message = "^chore", group = "ğŸ« Chores", skip = true },
  { message = "pre-commit autoupdate", skip = true },
  { message = "sync with (repo|repository) template", skip = true },
  { message = "sync with template (repo|repository)", skip = true },
  { message = "update pre-commit hooks", skip = true },
  # { message = '^fix\((?<scope>deps(-dev)?)\):', group = "<!-- 25 -->â¬†ï¸ Dependencies" },
  { message = "^feat", group = "<!-- 10 -->âœ¨ Features" },
  { message = "^fix", group = "<!-- 20 -->ğŸ› Bug Fixes" },
  { message = "^docs", group = "<!-- 30 -->ğŸ“ Documentation" },
  { message = "^style", group = "<!-- 40 -->ğŸ’„ Styles" },
  { message = "^refactor", group = "<!-- 50 -->â™» Code Refactoring" },
  { message = "^perf", group = "<!-- 60 -->âš¡ï¸ Performance Improvements" },
  { message = "^test", group = "<!-- 70 -->âœ… Tests" },
  { message = "^build", group = "<!-- 80 -->ğŸ›  Builds" },
  { message = "^ci", group = "<!-- 90 -->âš™ï¸ Continuous Integration" },
  { message = "^revert", group = "<!-- 95 -->âªï¸ Reverts" },
]
protect_breaking_commits = true
filter_commits = true
tag_pattern = "v[0-9].*"
topo_order = true
topo_order_commits = true
